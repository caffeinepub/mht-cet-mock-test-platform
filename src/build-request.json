{
  "kind": "build_request",
  "title": "Fix admin registration bootstrapping logic to allow first admin registration",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-170",
      "text": "Update the registerAdmin endpoint in backend/main.mo to fix the authorization flow by checking if the admin principals list is empty (AdminState.adminPrincipals.size() == 0) BEFORE running any authorization checks, allowing the first admin registration to succeed without 'User is not registered' or 'Unauthorized' errors when no admins exist yet",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ],
        "quotes": [
          "Registration failed: User is not registered",
          "Debug Panel shows: isAuthenticated: true, userRole: undefined, isAdmin: false"
        ]
      },
      "acceptanceCriteria": [
        "The registerAdmin endpoint checks admin list size first before any authorization logic",
        "When admin list is empty (size == 0), registration proceeds immediately without authorization checks",
        "The first user can successfully register as admin without 'User is not registered' error",
        "Subsequent registrations require existing admin authorization after the first admin is registered"
      ]
    },
    {
      "id": "REQ-171",
      "text": "Add comprehensive diagnostic logging to the registerAdmin endpoint in backend/main.mo that logs the admin principals list size (AdminState.adminPrincipals.size()), whether this is first-time setup (size == 0), the caller's Internet Identity principal, the principal being registered, each step of the authorization check with pass/fail reasoning, and the final registration outcome with timestamps",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ]
      },
      "acceptanceCriteria": [
        "Logs show admin list size before authorization checks",
        "Logs clearly indicate if this is first-time setup (bootstrapping)",
        "Logs show the exact authorization decision path taken",
        "All logs include timestamps for debugging the registration flow"
      ]
    },
    {
      "id": "REQ-172",
      "text": "Update the AdminRegistration.tsx component to automatically refetch the user role query using React Query invalidation immediately after successful first admin registration, display a prominent success message confirming first admin status, and automatically navigate to the Admin Dashboard after a 2-second delay",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-final"
        ]
      },
      "acceptanceCriteria": [
        "User role query is invalidated and refetched after successful registration",
        "Success message clearly indicates first admin registration succeeded",
        "User is automatically redirected to Admin Dashboard after 2 seconds",
        "UI updates immediately to reflect new admin status without manual page refresh"
      ]
    }
  ],
  "constraints": [
    "Do not modify the single-actor backend architecture",
    "Preserve all existing admin authorization checks for subsequent registrations after first admin",
    "Do not change the Internet Identity authentication flow",
    "Maintain all existing stable storage structures for admin principals"
  ],
  "nonGoals": [
    "Adding multi-admin registration workflows beyond first-time setup",
    "Implementing admin role revocation or removal",
    "Creating admin permission levels or granular access control",
    "Adding email or notification system for admin registration"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}